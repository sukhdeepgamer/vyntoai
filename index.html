<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VyntoAI | Professional Paper Digitizer</title>
    <!-- CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #f1f5f9;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Noto Sans Devanagari', sans-serif;
            color: #0f172a;
        }

        /* The Viewport: Centers the paper for screen preview */
        .paper-viewport {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            background: #cbd5e1;
            min-height: calc(100vh - 70px);
        }

        /* The scaling container: Shrinks the paper to fit the screen width */
        .paper-scaler {
            transform-origin: top center;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 100%;
        }

        /* The Paper Sheet: Letter size for screen preview */
        .paper-sheet {
            width: 215.9mm; 
            min-height: 279.4mm; 
            padding: 40px;
            background: white;
            color: black;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: none; 
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        /* Loader */
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        
        /* PRINT STYLES - Optimized for high density and exactly matching requested layout */
        @media print {
            @page {
                size: letter;
                margin: 15mm; 
            }
            body, html {
                background: white !important;
                width: 100% !important;
                height: auto;
                overflow: visible !important;
            }
            .no-print, header, #view-upload, #view-loading, #view-error {
                display: none !important;
            }
            .paper-viewport {
                padding: 0 !important;
                background: white !important;
                display: block !important;
                overflow: visible !important;
                min-height: auto !important;
            }
            .paper-scaler {
                transform: scale(1) !important;
                width: 100% !important;
                display: block !important;
                margin-bottom: 0 !important;
            }
            .paper-sheet {
                display: block !important;
                box-shadow: none !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important; 
                border: none !important;
                min-height: auto !important; 
                font-family: Arial, sans-serif !important;
                line-height: 1.6 !important;
                overflow: visible !important;
            }
            #view-result {
                display: block !important;
            }
            h3 { 
                text-align: center; 
                margin: 25px 0 15px 0; 
                font-size: 16pt; 
                font-weight: bold;
                page-break-after: avoid;
            }
            .section-container {
                page-break-inside: avoid; /* Keeps heading with questions */
                margin-top: 20px;
            }
            .section-title { 
                font-weight: bold; 
                font-size: 12pt; 
                margin-bottom: 5px;
            }
            .marks { 
                float: right; 
                font-weight: bold; 
            }
            .clear { clear: both; }
            ol { padding-left: 25px !important; margin: 10px 0 !important; }
            li { margin-bottom: 8px !important; font-size: 11pt; }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <!-- Header UI -->
    <header class="bg-slate-900 text-white py-4 px-4 md:px-8 shadow-md flex justify-between items-center no-print sticky top-0 z-50 w-full">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center font-black text-sm">V</div>
            <h1 class="text-lg md:text-xl font-black tracking-tighter">Vynto<span class="text-indigo-400">AI</span></h1>
        </div>
        <div id="top-actions" class="hidden flex gap-2">
            <button id="btn-download" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95 text-xs md:text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>Download PDF</span>
            </button>
            <button id="btn-reload" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg font-bold transition-all text-xs md:text-sm">Reset</button>
        </div>
    </header>

    <main class="w-full max-w-4xl mx-auto p-4 md:p-8 no-print">
        
        <!-- STEP 1: UPLOAD -->
        <div id="view-upload" class="max-w-2xl mx-auto bg-white rounded-[2.5rem] p-8 md:p-12 shadow-2xl shadow-slate-200/50 border border-slate-100 text-center">
            <div class="bg-indigo-50 text-indigo-600 w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg>
            </div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">Paper Digitizer</h2>
            <p class="text-slate-500 mb-8 text-sm md:text-base">Upload up to 6 photos. VyntoAI creates a professional, watermark-free PDF.</p>
            
            <div id="image-previews" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8"></div>

            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <button id="trigger-camera" class="flex-1 bg-slate-50 border-2 border-slate-200 h-14 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-slate-100 transition-all text-slate-700">Camera</button>
                <button id="trigger-files" class="flex-1 bg-slate-50 border-2 border-slate-200 h-14 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-slate-100 transition-all text-slate-700">Gallery</button>
            </div>

            <div id="photo-count" class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">0 / 6 Photos</div>

            <button id="btn-process" class="hidden w-full bg-indigo-600 text-white h-16 rounded-2xl font-black text-lg shadow-2xl shadow-indigo-200 hover:bg-indigo-700 transition-all active:scale-95">
                Generate Digital Paper
            </button>

            <!-- Hidden Inputs -->
            <input type="file" id="input-files" class="hidden" accept="image/*" multiple>
            <input type="file" id="input-camera" class="hidden" accept="image/*" capture="environment">
        </div>

        <!-- STEP 2: LOADING -->
        <div id="view-loading" class="hidden text-center py-20 bg-white rounded-[2.5rem] shadow-xl max-w-md mx-auto">
            <div class="loader-spinner mx-auto mb-6"></div>
            <h3 class="text-xl font-black text-slate-800">VyntoAI is Processing</h3>
            <p class="text-slate-400 font-bold uppercase text-xs tracking-widest mt-2" id="loading-msg">Formatting Document...</p>
        </div>

        <!-- STEP 3: ERROR -->
        <div id="view-error" class="hidden text-center py-12 bg-white rounded-[2.5rem] shadow-xl max-w-md mx-auto px-8 border-2 border-red-100">
            <div class="bg-red-50 text-red-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-xl font-black text-red-600 mb-2" id="error-title">Unexpected Error</h3>
            <p id="error-desc" class="text-slate-500 mb-6 text-sm">Please wait 60 seconds or try again later.</p>
            <button id="btn-error-retry" class="w-full bg-slate-900 text-white h-12 rounded-xl font-bold">Retry</button>
        </div>
    </main>

    <!-- STEP 4: RESULT -->
    <div id="view-result" class="hidden w-full">
        <div class="paper-viewport">
            <div class="paper-scaler" id="scaler">
                <div id="paper-output" class="paper-sheet">
                    <!-- AI Content Here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.40.0';

        const KEY = (typeof process !== 'undefined' && process.env.API_KEY) || "AIzaSyCasGllJV61krrupb8QPn23ITQPPSWXHC4";
        let imageList = [];
        const MAX_PHOTOS = 6;

        const resizeImage = (dataUrl) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 1500; 
                    if (width > height) { if (width > maxDim) { height *= maxDim / width; width = maxDim; } }
                    else { if (height > maxDim) { width *= maxDim / height; height = maxDim; } }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                };
                img.src = dataUrl;
            });
        };

        const onFilesAdded = async (event) => {
            const files = Array.from(event.target.files);
            if (imageList.length + files.length > MAX_PHOTOS) {
                alert(`You can only upload up to ${MAX_PHOTOS} photos.`);
                files.splice(MAX_PHOTOS - imageList.length);
            }
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const compressed = await resizeImage(e.target.result);
                    imageList.push(compressed);
                    updateUploadUI();
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        };

        const updateUploadUI = () => {
            const grid = document.getElementById('image-previews');
            grid.innerHTML = '';
            imageList.forEach((img, idx) => {
                const item = document.createElement('div');
                item.className = 'relative aspect-[3/4] rounded-2xl overflow-hidden shadow-lg border-2 border-white bg-slate-100';
                item.innerHTML = `<img src="${img}" class="w-full h-full object-cover">
                    <button onclick="window.removeImg(${idx})" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full shadow-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>`;
                grid.appendChild(item);
            });
            document.getElementById('photo-count').innerText = `${imageList.length} / ${MAX_PHOTOS} Photos`;
            document.getElementById('btn-process').classList.toggle('hidden', imageList.length === 0);
        };

        window.removeImg = (idx) => { imageList.splice(idx, 1); updateUploadUI(); };

        const startDigitization = async () => {
            if (imageList.length === 0) return;
            showView('loading');
            
            try {
                const ai = new GoogleGenAI({ apiKey: KEY });
                const prompt = `Transcribe the exam paper from the ${imageList.length} attached photos into a professional Question Paper format. 
                REQUIREMENTS:
                1. Detect and separate parts like "Part - A", "Part - B", "Part - C" etc.
                2. Extract metadata: Exam Title, Subject, Class, and Marks.
                3. Each section should have its number/title (e.g., "I. Fill in the blanks.") and the marks assigned on the right.
                4. List questions clearly using numbered lists.
                
                JSON FORMAT:
                {
                    "meta": { "exam": "FA - 3", "subject": "Science", "class": "7th", "marks": "40" },
                    "parts": [
                        {
                            "partName": "Part â€“ A",
                            "sections": [
                                { "id": "I", "title": "Fill in the blanks.", "marks": "(1 X 10 = 10M)", "questions": ["Question 1", "Question 2"] }
                            ]
                        }
                    ]
                }
                Output ONLY valid JSON. No watermarks or extra text.`;

                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: { parts: [...imageList.map(img => ({ inlineData: { mimeType: 'image/jpeg', data: img.split(',')[1] } })), { text: prompt }] },
                    config: { responseMimeType: "application/json" }
                });

                const data = JSON.parse(response.text);
                renderPaper(data);
                showView('result');
                setTimeout(adjustScale, 200);
                document.getElementById('top-actions').classList.remove('hidden');

            } catch (err) {
                const desc = document.getElementById('error-desc');
                const title = document.getElementById('error-title');
                if (err.message && err.message.includes('429')) {
                    title.innerText = "Quota Limit Reached";
                    desc.innerText = "Free tier limit reached. Please wait 60 seconds or try again tomorrow.";
                } else {
                    title.innerText = "Processing Error";
                    desc.innerText = "Error: " + (err.message || "Failed to analyze paper.");
                }
                showView('error');
            }
        };

        const renderPaper = (data) => {
            const out = document.getElementById('paper-output');
            out.style.display = 'block';
            const meta = data.meta || {};
            const parts = data.parts || [];

            // Professional Header with <br> as requested
            let html = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 25px; font-family: Arial, sans-serif; line-height: 1.6; color: black; border-bottom: 1px solid #000; padding-bottom: 10px;">
                    <div><b>${meta.exam || 'EXAM'}</b><br><b>Subject:</b> ${meta.subject || '_______'}</div>
                    <div style="text-align: right;"><b>Class:</b> ${meta.class || '_______'}<br><b>Marks:</b> ${meta.marks || '___'}</div>
                </div>
            `;

            parts.forEach(part => {
                // Centered H3 heading for Parts
                html += `<h3 style="text-align: center; margin: 30px 0 20px 0; font-family: Arial, sans-serif; font-weight: bold; font-size: 16pt;">${part.partName || 'Part'}</h3>`;
                
                (part.sections || []).forEach(sec => {
                    // Wrapped in section-container with page-break-inside: avoid to prevent orphaned headers
                    html += `
                        <div class="section-container" style="font-family: Arial, sans-serif; color: black;">
                            <p class="section-title">
                                <b>${sec.id ? sec.id + '. ' : ''}${sec.title || ''}</b> 
                                <span class="marks">${sec.marks || ''}</span>
                            </p>
                            <div class="clear"></div>
                            <ol style="padding-left: 30px; margin-top: 10px;">
                                ${(sec.questions || []).map(q => `<li style="margin-bottom: 10px; font-size: 11.5pt; text-align: justify; line-height: 1.6;">${q}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                });
            });

            out.innerHTML = html;
        };

        const adjustScale = () => {
            const scaler = document.getElementById('scaler');
            const paper = document.getElementById('paper-output');
            if (!scaler || !paper || paper.style.display === 'none') return;
            const vw = window.innerWidth - 30;
            const pw = 215.9 * 3.78; 
            if (vw < pw) {
                const r = vw / pw;
                scaler.style.transform = `scale(${r})`;
                scaler.style.marginBottom = `-${paper.offsetHeight * (1 - r)}px`;
            } else {
                scaler.style.transform = 'scale(1)';
                scaler.style.marginBottom = '0px';
            }
        };

        window.addEventListener('resize', adjustScale);

        const showView = (id) => {
            ['view-upload', 'view-loading', 'view-error', 'view-result'].forEach(v => {
                const el = document.getElementById(v);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById('view-' + id);
            if (target) target.classList.remove('hidden');
        };

        document.getElementById('trigger-files').onclick = () => document.getElementById('input-files').click();
        document.getElementById('trigger-camera').onclick = () => document.getElementById('input-camera').click();
        document.getElementById('input-files').onchange = onFilesAdded;
        document.getElementById('input-camera').onchange = onFilesAdded;
        document.getElementById('btn-process').onclick = startDigitization;
        document.getElementById('btn-reload').onclick = () => location.reload();
        document.getElementById('btn-error-retry').onclick = () => location.reload();
        document.getElementById('btn-download').onclick = () => {
            window.print();
        };

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>n-download').onclick = () => window.print();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>